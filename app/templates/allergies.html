{% extends "base.html" %}

{% block title %}Allergies - {{ patient.name_display if patient else 'Med-Z1' }}{% endblock %}

{% block content %}
<div class="page-container">
    {% if error %}
        <!-- Error State -->
        <div class="page-error">
            <div class="page-error__icon">
                <i class="fa-solid fa-triangle-exclamation fa-3x"></i>
            </div>
            <h2 class="page-error__title">Error Loading Allergies</h2>
            <p class="page-error__message">{{ error }}</p>
            <a href="/" class="btn btn--primary">
                <i class="fa-solid fa-house"></i>
                Return to Dashboard
            </a>
        </div>
    {% elif not patient %}
        <!-- No Patient State -->
        <div class="page-error">
            <div class="page-error__icon">
                <i class="fa-regular fa-user fa-3x"></i>
            </div>
            <h2 class="page-error__title">No Patient Selected</h2>
            <p class="page-error__message">Please select a patient to view their allergies</p>
            <a href="/" class="btn btn--primary">
                <i class="fa-solid fa-house"></i>
                Return to Dashboard
            </a>
        </div>
    {% else %}
        <!-- Page Header with VistA Refresh Controls -->
        <div class="page-header-breadcrumb">
            <!-- Breadcrumbs (left-aligned) -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <a href="/?icn={{ patient.icn }}" class="breadcrumb-link">
                    <i class="fa-solid fa-house"></i>
                    Dashboard
                </a>
                <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
                <span class="breadcrumb-current">Allergies</span>
            </nav>

            <!-- VistA Refresh Controls (right-aligned) -->
            <div id="vista-refresh-controls" class="vista-controls">
                <span class="data-freshness" id="freshness-message">
                    {% if vista_refreshed %}
                        Data current through: {{ data_current_through }} (today)
                        <span class="last-updated">Last updated: {{ last_updated }}</span>
                    {% else %}
                        Data current through: {{ data_current_through }}{% if data_freshness_label %} ({{ data_freshness_label }}){% endif %}
                    {% endif %}
                </span>

                {% if not vista_refreshed or True %}
                <button
                    type="button"
                    hx-post="/patient/{{ patient.icn }}/allergies/realtime"
                    hx-target="#vista-refresh-area"
                    hx-swap="outerHTML"
                    hx-indicator="#vista-loading"
                    aria-label="Refresh data from VistA sites"
                    class="btn btn--secondary vista-refresh-btn"
                    onclick="console.log('Allergies Refresh clicked!')">
                    <i class="fa-solid fa-rotate"></i> Refresh VistA
                </button>
                {% endif %}

                <div id="vista-loading" class="htmx-indicator">
                    <i class="fa-solid fa-spinner fa-spin"></i> Fetching data...
                </div>
            </div>
        </div>

        <!-- Vista Refresh Area - includes title and content for HTMX swap -->
        <div id="vista-refresh-area">

        <!-- Page Title Section -->
        <div class="page-header__title-group">
            <h1 class="page-header__title">
                Allergies & Adverse Reactions
            </h1>
        </div>

        <!-- Summary Stats -->
        <div class="allergies-summary-bar">
            <div class="allergy-stat-card">
                <div class="allergy-stat-card__value">{{ total_count }}</div>
                <div class="allergy-stat-card__label">Total Allergies</div>
            </div>
            <div class="allergy-stat-card">
                <div class="allergy-stat-card__value">{{ drug_count }}</div>
                <div class="allergy-stat-card__label">Drug Allergies</div>
            </div>
            <div class="allergy-stat-card">
                <div class="allergy-stat-card__value">{{ food_count }}</div>
                <div class="allergy-stat-card__label">Food Allergies</div>
            </div>
            <div class="allergy-stat-card">
                <div class="allergy-stat-card__value">{{ environmental_count }}</div>
                <div class="allergy-stat-card__label">Environmental</div>
            </div>
            {% if severe_count > 0 %}
            <div class="allergy-stat-card allergy-stat-card--severe">
                <div class="allergy-stat-card__value">{{ severe_count }}</div>
                <div class="allergy-stat-card__label">Severe</div>
            </div>
            {% endif %}
        </div>

        {% if total_count == 0 %}
            <!-- No Allergies State -->
            <div class="empty-state">
                <div class="empty-state__icon">
                    <i class="fa-solid fa-capsules fa-3x"></i>
                </div>
                <h3 class="empty-state__title">No Known Allergies</h3>
                <p class="empty-state__message">This patient has no documented allergies or adverse reactions</p>
            </div>
        {% else %}
            <!-- Drug Allergies Section -->
            {% if drug_allergies | length > 0 %}
            <div class="allergies-section">
                <div class="allergies-section__header">
                    <h2 class="allergies-section__title">
                        <i class="fa-solid fa-pills"></i>
                        Drug Allergies
                        <span class="allergies-section__count">{{ drug_allergies | length }}</span>
                    </h2>
                    <p class="allergies-section__description">Medications causing adverse reactions</p>
                </div>
                <div class="allergies-grid">
                    {% for allergy in drug_allergies %}
                        {% include 'partials/allergy_card.html' %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Food Allergies Section -->
            {% if food_allergies | length > 0 %}
            <div class="allergies-section">
                <div class="allergies-section__header">
                    <h2 class="allergies-section__title">
                        <i class="fa-solid fa-apple-whole"></i>
                        Food Allergies
                        <span class="allergies-section__count">{{ food_allergies | length }}</span>
                    </h2>
                    <p class="allergies-section__description">Foods causing adverse reactions</p>
                </div>
                <div class="allergies-grid">
                    {% for allergy in food_allergies %}
                        {% include 'partials/allergy_card.html' %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Environmental Allergies Section -->
            {% if environmental_allergies | length > 0 %}
            <div class="allergies-section">
                <div class="allergies-section__header">
                    <h2 class="allergies-section__title">
                        <i class="fa-solid fa-leaf"></i>
                        Environmental Allergies
                        <span class="allergies-section__count">{{ environmental_allergies | length }}</span>
                    </h2>
                    <p class="allergies-section__description">Environmental allergens and substances</p>
                </div>
                <div class="allergies-grid">
                    {% for allergy in environmental_allergies %}
                        {% include 'partials/allergy_card.html' %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endif %}

        </div>
        <!-- End Vista Refresh Area -->

    {% endif %}
</div>
{% endblock %}
