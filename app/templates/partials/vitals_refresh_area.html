{# Vista Refresh Area - returned by HTMX realtime endpoint #}
<div id="vista-refresh-area">

<!-- Page Title Section -->
<div class="page-header__title-group">
    <h1 class="page-header__title">
        Vital Signs
    </h1>
</div>

<!-- Filters and Controls -->
<div class="vitals-controls">
    <!-- Filter Pills -->
    <div class="filter-pills">
        <span class="filter-pills__label">Filter by Type:</span>
        <a href="/patient/{{ patient.icn }}/vitals?sort_by={{ sort_by }}&sort_order={{ sort_order }}"
           class="filter-pill {% if not vital_type_filter %}filter-pill--active{% endif %}">
            All Vitals ({{ total_count }})
        </a>
        {% for abbr, count in counts.items() %}
            {% set type_name = {
                'BP': 'Blood Pressure',
                'T': 'Temperature',
                'P': 'Pulse',
                'R': 'Respiration',
                'POX': 'Pulse Ox',
                'PN': 'Pain',
                'HT': 'Height',
                'WT': 'Weight',
                'BMI': 'BMI'
            }.get(abbr, abbr) %}
            <a href="/patient/{{ patient.icn }}/vitals?vital_type={{ type_name | upper }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
               class="filter-pill {% if vital_type_filter and vital_type_filter == type_name | upper %}filter-pill--active{% endif %}">
                {{ abbr }} ({{ count }})
            </a>
        {% endfor %}
    </div>

    <!-- Sort Controls -->
    <div class="sort-controls">
        <span class="sort-controls__label">Sort by:</span>
        <select class="sort-select" onchange="window.location.href=this.value">
            <option value="/patient/{{ patient.icn }}/vitals?{% if vital_type_filter %}vital_type={{ vital_type_filter }}&{% endif %}sort_by=taken_datetime&sort_order=desc"
                    {% if sort_by == 'taken_datetime' and sort_order == 'desc' %}selected{% endif %}>
                Date (Newest First)
            </option>
            <option value="/patient/{{ patient.icn }}/vitals?{% if vital_type_filter %}vital_type={{ vital_type_filter }}&{% endif %}sort_by=taken_datetime&sort_order=asc"
                    {% if sort_by == 'taken_datetime' and sort_order == 'asc' %}selected{% endif %}>
                Date (Oldest First)
            </option>
            <option value="/patient/{{ patient.icn }}/vitals?{% if vital_type_filter %}vital_type={{ vital_type_filter }}&{% endif %}sort_by=vital_type&sort_order=asc"
                    {% if sort_by == 'vital_type' %}selected{% endif %}>
                Vital Type (A-Z)
            </option>
            <option value="/patient/{{ patient.icn }}/vitals?{% if vital_type_filter %}vital_type={{ vital_type_filter }}&{% endif %}sort_by=abnormal_flag&sort_order=desc"
                    {% if sort_by == 'abnormal_flag' %}selected{% endif %}>
                Abnormal First
            </option>
        </select>
    </div>

    <!-- View Toggle Button -->
    <button id="view-toggle-btn" class="btn btn--secondary">
        <i class="fa-solid fa-chart-line"></i>
        View Charts
    </button>
</div>

<!-- Grid View (Table) -->
<div id="grid-view">
    {% if error %}
        <!-- Error State (VistA refresh failed) -->
        <div class="vitals-empty">
            <div class="vitals-empty__icon">
                <i class="fa-solid fa-triangle-exclamation fa-3x"></i>
            </div>
            <h3 class="vitals-empty__title">Error Fetching Real-Time Data</h3>
            <p class="vitals-empty__message">{{ error }}</p>
            <button onclick="window.location.reload()" class="btn btn--primary">
                <i class="fa-solid fa-rotate"></i>
                Retry
            </button>
        </div>
    {% elif vitals %}
    <div class="vitals-table-container">
        <table class="vitals-table">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Type</th>
                    <th>Value</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for vital in vitals %}
                <tr class="vital-row {% if vital.abnormal_flag in ['CRITICAL', 'HIGH', 'LOW'] %}vital-row--abnormal{% endif %}">
                    <!-- Date/Time -->
                    <td class="vital-cell vital-cell--datetime">
                        <div class="vital-datetime">
                            {{ vital.taken_datetime[:10] if vital.taken_datetime else '—' }}
                        </div>
                        <div class="vital-time">
                            {{ vital.taken_datetime[11:16] if vital.taken_datetime and vital.taken_datetime|length > 10 else '' }}
                        </div>
                    </td>

                    <!-- Type -->
                    <td class="vital-cell vital-cell--type">
                        <div class="vital-type-label">{{ vital.vital_type }}</div>
                        <div class="vital-abbr">
                            ({{ vital.vital_abbr }})
                            {% if vital.data_source %}
                                {% if vital.data_source == 'CDWWork' %}
                                    <span class="badge badge--info" title="VistA Data Source (CDWWork)" style="margin-left: 0.5rem; font-size: 0.75rem;">
                                        <i class="fa-solid fa-v"></i> VistA
                                    </span>
                                {% elif vital.data_source == 'CDWWork2' %}
                                    <span class="badge badge--success" title="Oracle Health Data Source (CDWWork2)" style="margin-left: 0.5rem; font-size: 0.75rem;">
                                        <i class="fa-solid fa-c"></i> Cerner
                                    </span>
                                {% elif vital.data_source == 'CALCULATED' %}
                                    <span class="badge badge--secondary" title="Calculated Value (BMI)" style="margin-left: 0.5rem; font-size: 0.75rem;">
                                        <i class="fa-solid fa-calculator"></i> Calc
                                    </span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>

                    <!-- Value -->
                    <td class="vital-cell vital-cell--value">
                        <div class="vital-value-display">
                            {{ vital.result_value }}
                            {% if vital.unit_of_measure %}
                                <span class="vital-unit">{{ vital.unit_of_measure }}</span>
                            {% endif %}
                        </div>
                        {% if vital.vital_abbr == 'BP' and vital.systolic and vital.diastolic %}
                            <div class="vital-subvalue">
                                Systolic: {{ vital.systolic }} / Diastolic: {{ vital.diastolic }}
                            </div>
                        {% elif vital.metric_value and vital.numeric_value and vital.metric_value != vital.numeric_value %}
                            <div class="vital-subvalue">
                                Metric: {{ vital.metric_value }}
                            </div>
                        {% endif %}
                    </td>

                    <!-- Status -->
                    <td class="vital-cell vital-cell--status">
                        {% if vital.abnormal_flag %}
                            {% if vital.abnormal_flag == 'CRITICAL' %}
                                <span class="badge badge--danger">CRITICAL</span>
                            {% elif vital.abnormal_flag == 'HIGH' %}
                                <span class="badge badge--warning">HIGH</span>
                            {% elif vital.abnormal_flag == 'LOW' %}
                                <span class="badge badge--info">LOW</span>
                            {% elif vital.abnormal_flag == 'NORMAL' %}
                                <span class="vital-status-normal">Normal</span>
                            {% endif %}
                        {% else %}
                            <span class="vital-status-none">—</span>
                        {% endif %}
                        {# Show Vista badge for real-time data #}
                        {% if vital.source == 'vista' and vital.source_site %}
                            <div class="mt-1">
                                <span class="badge badge--success" title="Real-time data from VistA Site {{ vital.source_site }}">
                                    <i class="fa-solid fa-bolt"></i> Site {{ vital.source_site }}
                                </span>
                            </div>
                        {% endif %}
                    </td>

                    <!-- Details -->
                    <td class="vital-cell vital-cell--details">
                        {% if vital.qualifiers and vital.qualifiers != '[]' %}
                            <div class="vital-qualifiers">
                                {% if vital.qualifiers is string %}
                                    {% set qualifiers_list = vital.qualifiers | tojson | fromjson %}
                                {% else %}
                                    {% set qualifiers_list = vital.qualifiers %}
                                {% endif %}
                                {% for qual in qualifiers_list %}
                                    <span class="qualifier-tag">
                                        {{ qual.qualifier_name }}
                                    </span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if vital.location_name %}
                            <div class="vital-meta">Location: {{ vital.location_name }}</div>
                        {% endif %}
                        {% if vital.entered_by %}
                            <div class="vital-meta">By: {{ vital.entered_by }}</div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <!-- Empty State -->
        <div class="vitals-empty">
            <div class="vitals-empty__icon">
                <i class="fa-solid fa-heart-pulse fa-3x"></i>
            </div>
            <h3 class="vitals-empty__title">No Vital Signs Found</h3>
            <p class="vitals-empty__message">
                {% if vital_type_filter %}
                    No {{ vital_type_filter }} vitals recorded for this patient.
                    <br>
                    <a href="/patient/{{ patient.icn }}/vitals" class="btn btn--link">View All Vitals</a>
                {% else %}
                    No vital signs have been recorded for this patient.
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>

<!-- Charts View (Hidden by default) -->
<div id="charts-view" style="display: none;">
    <div class="charts-grid">
        <!-- Blood Pressure Chart -->
        <div class="chart-container">
            <canvas id="chart-bp"></canvas>
        </div>

        <!-- Weight Chart -->
        <div class="chart-container">
            <canvas id="chart-weight"></canvas>
        </div>

        <!-- Pain Score Chart -->
        <div class="chart-container">
            <canvas id="chart-pain"></canvas>
        </div>
    </div>
</div>

</div> <!-- End vista-refresh-area -->

{# Out-of-band swap to update freshness message in vista-controls #}
<span class="data-freshness" hx-swap-oob="true" id="freshness-message">
    {% if vista_refreshed %}
        Data current through: {{ data_current_through }} (today)
        <span class="last-updated">Last updated: {{ last_updated }}</span>
    {% else %}
        Data current through: {{ data_current_through }}{% if data_freshness_label %} ({{ data_freshness_label }}){% endif %}
    {% endif %}

    {% if vista_cached %}
        <span class="badge badge--success" style="margin-left: 0.75rem;" title="Vista data cached from sites: {{ cache_sites|join(', ') }}">
            <i class="fa-solid fa-database"></i>
            Vista Cached (available to AI)
        </span>
    {% endif %}
</span>
