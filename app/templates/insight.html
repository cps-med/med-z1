{% extends "base.html" %}

{% block title %}AI Insights - {{ patient.name_display if patient else 'Med-Z1' }}{% endblock %}

{% block content %}
<div class="page-container">
    {% if error %}
        <!-- Error State -->
        <div class="page-error">
            <div class="page-error__icon">
                <i class="fa-solid fa-triangle-exclamation fa-3x"></i>
            </div>
            <h2 class="page-error__title">Error Loading AI Insights</h2>
            <p class="page-error__message">{{ error }}</p>
            <a href="/" class="btn btn--primary">
                <i class="fa-solid fa-house"></i>
                Return to Dashboard
            </a>
        </div>
    {% elif not patient %}
        <!-- No Patient State -->
        <div class="page-error">
            <div class="page-error__icon">
                <i class="fa-regular fa-user fa-3x"></i>
            </div>
            <h2 class="page-error__title">No Patient Selected</h2>
            <p class="page-error__message">Please select a patient to access AI insights</p>
            <a href="/" class="btn btn--primary">
                <i class="fa-solid fa-house"></i>
                Return to Dashboard
            </a>
        </div>
    {% else %}
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header__breadcrumb">
                <a href="/" class="breadcrumb-link">
                    <i class="fa-solid fa-house"></i>
                    Dashboard
                </a>
                <i class="fa-solid fa-chevron-right"></i>
                <span class="breadcrumb-current">Insights</span>
            </div>
            <div class="page-header__title-group">
                <h1 class="page-header__title">
                    Clinical Insights
                </h1>
            </div>
        </div>

        <!-- Vista Cache Status -->
        {% if cache_info %}
        {% set cached_domains = cache_info.values()|selectattr("cached")|selectattr("expired", "equalto", false)|list %}
        <div class="info-box info-box--{% if cached_domains %}success{% else %}info{% endif %}" style="margin-bottom: 1.5rem;">
            <!-- CPS 1/2/25: commenting out next line to remove icon -->
            <!-- <i class="fa-solid fa-{% if cached_domains %}database{% else %}info-circle{% endif %}"></i> -->
            <div class="info-box__content">
                <strong>Data Sources:</strong>
                {% if cached_domains %}
                    AI analysis will automatically use cached Vista data.
                    <strong>Cached domains:</strong>
                    {% for domain, info in cache_info.items() if info.cached and not info.expired %}
                        <span class="badge badge--success" style="margin-left: 0.5rem;" title="{{ info.record_count }} records from {{ info.sites|join(', ') }}">
                            <i class="fa-solid fa-circle-check"></i>
                            {{ domain|title }} ({{ info.age_minutes }} min ago)
                        </span>
                    {% endfor %}
                {% else %}
                    AI will use PostgreSQL data only. Use "Refresh Vista" on clinical domain pages to enable real-time data analysis.
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Chat Container -->
        <div class="insight-container">

            <!-- Chat History -->
            <div id="chat-history" class="chat-history">
                <!-- Messages will be appended here via HTMX -->
                {% for msg in chat_messages %}
                    {% set message_type = msg.message_type %}
                    {% set message_text = msg.message_text %}
                    {% set timestamp = msg.timestamp %}
                    {% set tools_used = msg.get('tools_used', None) %}
                    {% include "partials/chat_message.html" %}
                {% endfor %}
            </div>

            <!-- Input Form -->
            <form
                id="chat-form"
                hx-post="/insight/chat"
                hx-target="#chat-history"
                hx-swap="beforeend"
                hx-on::after-request="this.reset(); hideSuggestions();"
                hx-indicator="#loading-indicator"
            >
                <input type="hidden" name="icn" value="{{ patient.icn }}">
                <input type="hidden" id="clinician-email" value="{{ user.email if user else 'unknown@va.gov' }}">

                <div class="chat-input-container">
                    <!-- Sparkle button to open suggested questions modal -->
                    <button
                        type="button"
                        class="btn btn--icon chat-sparkle-btn"
                        data-modal-open="suggested-questions-modal"
                        title="Suggested questions"
                        aria-label="View suggested questions"
                    >
                        <i class="fa-solid fa-sparkles"></i>
                    </button>

                    <textarea
                        name="message"
                        id="message-input"
                        placeholder="Ask a question..."
                        rows="2"
                        required
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"
                    ></textarea>

                    <button
                        type="submit"
                        class="btn btn--primary btn--icon chat-submit-btn"
                        title="Submit question"
                        aria-label="Submit question"
                    >
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="htmx-indicator">
                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                    Analyzing...
                </div>
            </form>

            <!-- Transcript Download Actions -->
            <div class="transcript-download-actions">
                <button
                    type="button"
                    class="btn btn--secondary"
                    data-modal-open="transcript-download-modal"
                    title="Download conversation transcript"
                >
                    <i class="fa-solid fa-download"></i>
                    Download Transcript
                </button>

                <!-- Phase 6: Clear Chat History -->
                <button
                    type="button"
                    class="btn btn--secondary"
                    hx-post="/insight/clear-history"
                    hx-vals='{"icn": "{{ patient.icn }}"}'
                    hx-target="#chat-history"
                    hx-swap="innerHTML"
                    hx-confirm="Are you sure you want to clear the chat history? This cannot be undone."
                    title="Clear conversation history"
                >
                    <i class="fa-solid fa-trash"></i>
                    Clear Chat History
                </button>
            </div>

            <!-- AI Disclaimer -->
            <div class="ai-disclaimer">
                <i class="fa-solid fa-info-circle"></i>
                <strong>AI-generated insights.</strong> Always verify clinically before making decisions.
                This tool provides decision support, not medical advice.
            </div>

        </div>

        <!-- Suggested Questions Modal -->
        {% include "partials/suggested_questions_modal.html" %}

        <!-- Transcript Download Modal -->
        {% include "partials/transcript_download_modal.html" %}

    {% endif %}
</div>

<script>
// Select a suggested question from the modal
function selectSuggestedQuestion(question) {
    // Populate the textarea
    document.getElementById('message-input').value = question;

    // Close the modal
    const modal = document.getElementById('suggested-questions-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Focus the textarea so user can edit if desired
    document.getElementById('message-input').focus();
}

// No-op function for HTMX compatibility (chips removed)
function hideSuggestions() {
    // Chips removed - no action needed
}
</script>

<!-- Transcript Download JavaScript -->
<script src="{{ url_for('static', path='/transcript.js') }}"></script>

{% endblock %}
